include:
  - template: Auto-DevOps.gitlab-ci.yml

stages:
  - build
  - package

variables:
  YARN_CACHE_FOLDER: '${CI_PROJECT_DIR}/.cache/yarn'

.cache:
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - .cache/yarn

install:
  stage: build
  extends: .cache
  image: node:14-alpine
  before_script:
    - apk update && apk upgrade && apk add --no-cache git
  script:
    - yarn --frozen-lockfile --silent
  only:
    changes:
      - yarn.lock

.docker:
  image: docker:19-dind
  services:
    - name: docker:19-dind
      command: ['--mtu=1450']
  tags:
    - cluster
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ''
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

.frontend:
  script:
    - docker pull $DOCKER_RELEASE_IMAGE || true
    - docker build --cache-from $DOCKER_RELEASE_IMAGE --build-arg
      GITLAB_BASE_URL --build-arg GITLAB_REPOSITORY --build-arg
      GITLAB_REPOSITORY_BRANCH --build-arg GITLAB_ACCESS_TOKEN --build-arg
      SSHOC_OPENAPI_DOCUMENT_URL --build-arg NEXT_PUBLIC_SSHOC_BASE_URL
      --build-arg NEXT_PUBLIC_SSHOC_API_BASE_URL --build-arg
      NEXT_PUBLIC_RECAPTCHA_SITE_KEY --build-arg NEXT_PUBLIC_MATOMO_BASE_URL
      --build-arg NEXT_PUBLIC_MATOMO_SITE_ID --tag $DOCKER_CURRENT_IMAGE --tag
      $DOCKER_RELEASE_IMAGE .
    - docker push $DOCKER_CURRENT_IMAGE
    - docker push $DOCKER_RELEASE_IMAGE

package:frontend:main:acdh:
  stage: package
  extends:
    - .docker
    - .frontend
  variables:
    DOCKER_RELEASE_IMAGE: ${CI_REGISTRY_IMAGE}/frontend:latest
    DOCKER_CURRENT_IMAGE: ${CI_REGISTRY_IMAGE}/frontend:$CI_COMMIT_SHORT_SHA
    GITLAB_BASE_URL: https://gitlab.gwdg.de
    GITLAB_REPOSITORY: sshoc/sshoc-marketplace-frontend
    SSHOC_OPENAPI_DOCUMENT_URL: https://sshoc-marketplace-api.acdh-dev.oeaw.ac.at/v3/api-docs
    NEXT_PUBLIC_SSHOC_BASE_URL: https://sshoc-marketplace.acdh-dev.oeaw.ac.at
    NEXT_PUBLIC_SSHOC_API_BASE_URL: https://sshoc-marketplace-api.acdh-dev.oeaw.ac.at
    NEXT_PUBLIC_MATOMO_SITE_ID: 190
    # NEXT_PUBLIC_RECAPTCHA_SITE_KEY:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

package:frontend:tags:acdh:
  stage: package
  extends:
    - .docker
    - .frontend
  variables:
    DOCKER_RELEASE_IMAGE: ${CI_REGISTRY_IMAGE}/frontend:release
    DOCKER_CURRENT_IMAGE: ${CI_REGISTRY_IMAGE}/frontend:$CI_COMMIT_TAG
    GITLAB_BASE_URL: https://gitlab.gwdg.de
    GITLAB_REPOSITORY: sshoc/sshoc-marketplace-frontend
    SSHOC_OPENAPI_DOCUMENT_URL: https://marketplace-api.sshopencloud.eu/v3/api-docs
    NEXT_PUBLIC_SSHOC_BASE_URL: https://marketplace.sshopencloud.eu
    NEXT_PUBLIC_SSHOC_API_BASE_URL: https://marketplace-api.sshopencloud.eu
    # NEXT_PUBLIC_RECAPTCHA_SITE_KEY:
    NEXT_PUBLIC_MATOMO_BASE_URL: https://matomo.acdh.oeaw.ac.at/
    NEXT_PUBLIC_MATOMO_SITE_ID: 179
  rules:
    - if: '$CI_COMMIT_TAG != null'
